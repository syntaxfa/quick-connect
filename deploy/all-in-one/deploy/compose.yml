---
name: "quick-connect-all-in-one"

volumes:
  all_in_one_postgres_data:

networks:
  app_net:
    internal: true
  web_net:

services:
  postgres:
    image: postgres:18
    container_name: all_in_one_postgres
    hostname: ${MANAGER_POSTGRES__HOST}
    command: -p ${MANAGER_POSTGRES__PORT}
    restart: always
    environment:
      - POSTGRES_DB=${MANAGER_POSTGRES__DB_NAME}
      - POSTGRES_USER=${MANAGER_POSTGRES__USERNAME}
      - POSTGRES_PASSWORD=${MANAGER_POSTGRES__PASSWORD}
    volumes:
      - all_in_one_postgres_data:/var/lib/postgresql
      - ./postgres-init:/docker-entrypoint-initdb.d
    networks:
      - app_net
    healthcheck:
      test: [CMD-SHELL, "sh -c 'pg_isready -U ${MANAGER_POSTGRES__USERNAME} -d ${MANAGER_POSTGRES__DB_NAME} -p ${MANAGER_POSTGRES__PORT}'"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:8.4.0
    container_name: redis
    hostname: ${ALL_IN_ONE_REDIS__HOST}
    restart: always
    command: redis-server --requirepass ${ALL_IN_ONE_REDIS__PASSWORD} --port ${ALL_IN_ONE_REDIS__PORT}
    environment:
      REDIS_PASSWORD: ${ALL_IN_ONE_REDIS__PASSWORD}
      REDIS_PORT: ${ALL_IN_ONE_REDIS__PORT}
    volumes:
      - ./redis.conf:/usr/local/etc/redis.conf
    networks:
      - app_net
    healthcheck:
      test: ["CMD", "redis-cli", "-h", "localhost", "-p", "${ALL_IN_ONE_REDIS__PORT:?error}", "-a", "${ALL_IN_ONE_REDIS__PASSWORD:?error}", "PING"]
      interval: 5s
      timeout: 5s
      retries: 10

  init:
    image: syntaxfa/quickconnect-all-in-one:1.0.2
    container_name: init
    command: >
      /bin/sh -c "
      ./all-in-one manager migrate up &&
      ./all-in-one chat migrate up &&
      ./all-in-one notification migrate up &&
      ./all-in-one manager create-user --username=${SUPERUSER_USERNAME} --password=${SUPERUSER_PASSWORD} --fullname=${SUPERUSER_FULLNAME} --email=${SUPERUSER_EMAIL} --phone_number=${SUPERUSER_PHONE_NUMBER} --role=${SUPERUSER_ROLE} --role=support
      "
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - app_net
    env_file: .env

  quick_connect:
    image: syntaxfa/quickconnect-all-in-one:1.0.2
    container_name: quick_connect
    hostname: quick_connect
    restart: always
    ports:
      - ${MANAGER_HTTP_SERVER__PORT}:${MANAGER_HTTP_SERVER__PORT}
      - ${ADMIN_HTTP_SERVER__PORT}:${ADMIN_HTTP_SERVER__PORT}
      - ${CHAT_HTTP_SERVER__PORT}:${CHAT_HTTP_SERVER__PORT}
    networks:
      - app_net
      - web_net
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file: .env
